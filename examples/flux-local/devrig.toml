[project]
name = "flux-local"

[dashboard]

[links]
headlamp = "http://localhost:8080"
flux-ui = "http://localhost:9090"

[services.git-server]
command = "bash setup.sh"
port = 9080

[cluster]

[cluster.logs]
namespaces = "all"

# Customize k3s built-in Traefik with OTLP tracing and metrics
[cluster.addons.traefik-config]
type = "manifest"
path = "k8s/traefik-config.yaml"
namespace = "kube-system"
port_forward = { 8080 = "svc/traefik:80" }

# Flux Operator (with web UI on :9080)
[cluster.addons.flux-operator]
type = "helm"
chart = "oci://ghcr.io/controlplaneio-fluxcd/charts/flux-operator"
namespace = "flux-system"
wait = true
port_forward = { 9090 = "svc/flux-operator:9080" }

# Flux Instance (installs Flux controllers via the operator)
[cluster.addons.flux-instance]
type = "helm"
chart = "oci://ghcr.io/controlplaneio-fluxcd/charts/flux-instance"
namespace = "flux-system"
wait = true
timeout = "10m"
depends_on = ["flux-operator"]

# Bootstrap: GitRepository + Kustomizations pointing to local git server
[cluster.addons.flux-bootstrap]
type = "manifest"
path = "k8s/bootstrap.yaml"
namespace = "flux-system"
depends_on = ["flux-instance"]

# Headlamp admin service account (creates a token for dashboard login)
[cluster.addons.headlamp-admin]
type = "manifest"
path = "k8s/headlamp-admin.yaml"
namespace = "headlamp"
depends_on = ["flux-bootstrap"]
